{% extends "upload/base.html" %}
{% load static %}

{% block content %}
<h2>PPT → PDF 변환</h2>
<p class="mb-4">PPT 또는 PPTX 파일을 업로드하여 PDF로 변환합니다.</p>

<form id="uploadForm">
  {% csrf_token %}
  <input type="file" name="file" id="fileInput" accept=".ppt,.pptx" class="form-control mb-3" required>

  <button type="submit" id="submitBtn" class="btn btn-primary w-100 mt-3">
    PDF로 변환하기
  </button>
</form>

<div id="statusMessage" class="mt-3 alert alert-secondary" style="display:none;"></div>

<script>
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault(); // 화면 깜빡임 방지
    
    const fileInput = document.getElementById('fileInput');
    const submitBtn = document.getElementById('submitBtn');
    const statusDiv = document.getElementById('statusMessage');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // UI 업데이트
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 전송 중...';
    statusDiv.style.display = 'block';
    statusDiv.className = 'mt-3 alert alert-info';
    statusDiv.innerText = "파일을 서버로 전송하고 있습니다...";

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    try {
        // 1. 업로드 요청
        const response = await fetch('/convert/ppt_to_pdf/', {
            method: 'POST',
            headers: {'X-CSRFToken': csrfToken},
            body: formData
        });

        if (!response.ok) throw new Error("서버 연결 실패");

        const data = await response.json();
        const jobId = data.job_id;

        statusDiv.innerText = "변환 작업이 시작되었습니다. 잠시만 기다려주세요...";
        
        // 2. 상태 확인 (Polling)
        pollStatus(jobId, '/convert/ppt_to_pdf/'); // URL은 로깅용

    } catch (error) {
        showError(error.message);
    }
});

function pollStatus(jobId) {
    const statusDiv = document.getElementById('statusMessage');
    const submitBtn = document.getElementById('submitBtn');

    const intervalId = setInterval(async () => {
        try {
            const res = await fetch(`/api/status/${jobId}/`);
            const data = await res.json();

            if (data.status === 'Completed') {
                clearInterval(intervalId);
                statusDiv.className = 'mt-3 alert alert-success';
                statusDiv.innerText = "변환 완료! 파일이 자동으로 다운로드됩니다.";
                
                submitBtn.innerText = "처리 완료!";
                
                // 3. 다운로드
                window.location.href = `/api/download/${jobId}/`;

            } else if (data.status === 'Failed') {
                clearInterval(intervalId);
                showError("변환 실패: " + (data.message || "알 수 없는 오류"));
            }
        } catch (e) {
            clearInterval(intervalId);
            showError("상태 확인 중 통신 오류");
        }
    }, 2000); // 2초마다 확인
}

function showError(msg) {
    const statusDiv = document.getElementById('statusMessage');
    const submitBtn = document.getElementById('submitBtn');
    statusDiv.className = 'mt-3 alert alert-danger';
    statusDiv.innerText = msg;

    submitBtn.disabled = false;
    submitBtn.innerText = "PDF로 변환하기";
}
</script>
{% endblock %}