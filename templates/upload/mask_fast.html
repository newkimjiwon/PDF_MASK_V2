{% extends "upload/base.html" %}
{% load static %}

{% block content %}
<h2>ë¹ ë¥¸ ë§ˆìŠ¤í‚¹</h2>
<p class="mb-4">PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ í‚¤ì›Œë“œ ê¸°ë°˜ ë¹ ë¥¸ ë§ˆìŠ¤í‚¹ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.</p>

<form id="uploadForm">
  {% csrf_token %}
  
  <input type="file" name="file" accept="application/pdf" class="form-control mb-3" required>

  <select name="mode" class="form-select mb-2">
    <option value="redact">ë§ˆìŠ¤í‚¹</option>
    <option value="highlight">ê°•ì¡° í‘œì‹œ</option>
  </select>

  <select name="target_mode" class="form-select mb-2">
    <option value="both">ì „ì²´ ì‚¬ìš©</option>
    <option value="josa_only">ì¡°ì‚¬ ê¸°ì¤€</option>
    <option value="nouns_only">ëª…ì‚¬ ê¸°ì¤€</option>
  </select>

  <input type="text" name="mask_ratio" value="0.95" 
         class="form-control mb-3" placeholder="ë§ˆìŠ¤í‚¹ ì •ë„ (0~1)">

  <button type="submit" id="submitBtn" class="btn btn-primary w-100 mt-3">
    ì—…ë¡œë“œ & ë§ˆìŠ¤í‚¹ ì‹¤í–‰
  </button>
</form>

<div id="statusMessage" class="mt-3 alert alert-secondary" style="display:none;"></div>

<script>
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const statusDiv = document.getElementById('statusMessage');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ì²˜ë¦¬ ì¤‘...';
    
    statusDiv.style.display = 'block';
    statusDiv.className = 'mt-3 alert alert-info';
    statusDiv.innerText = "ë°ì´í„° ì „ì†¡ ë° ë¶„ì„ ìš”ì²­ ì¤‘...";

    const formData = new FormData(this);

    try {
        // ì—¬ê¸°ê°€ '/api/mask/'ì—¬ì•¼ í•©ë‹ˆë‹¤!
        const response = await fetch('/api/mask/', {
            method: 'POST',
            headers: {'X-CSRFToken': csrfToken},
            body: formData
        });

        if (!response.ok) throw new Error("ìš”ì²­ ì‹¤íŒ¨");
        const data = await response.json();

        statusDiv.innerText = "ë§ˆìŠ¤í‚¹ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤...";
        pollStatus(data.job_id);

    } catch (error) {
        showError(error.message);
    }
});

function pollStatus(jobId) {
    const statusDiv = document.getElementById('statusMessage');
    const submitBtn = document.getElementById('submitBtn');
    const intervalId = setInterval(async () => {
        try {
            const res = await fetch(`/api/status/${jobId}/`);
            const data = await res.json();

            if (data.status === 'Completed') {
                clearInterval(intervalId);

                const downloadUrl = `/api/download/${jobId}/`;

                statusDiv.className = 'mt-3 alert alert-success';
                statusDiv.innerHTML = `
                    <strong>ë³€í™˜ ì™„ë£Œ!</strong><br>
                    ë‹¤ìš´ë¡œë“œë¥¼ í•˜ê¸° ìœ„í•´ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.<br>
                    <a href="${downloadUrl}" class="btn btn-success mt-2 w-100">
                        ğŸ“‚ íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•˜ê¸°
                    </a>
                `;
                
                submitBtn.innerText = "ì²˜ë¦¬ ì™„ë£Œ!";

            } else if (data.status === 'Failed') {
                clearInterval(intervalId);
                showError("ì‹¤íŒ¨: " + data.message);
            }
        } catch (e) {
            clearInterval(intervalId);
            showError("í†µì‹  ì—ëŸ¬");
        }
    }, 2000);
}

// ì—ëŸ¬ ë°œìƒ ì‹œ ë²„íŠ¼ì„ ì›ìƒë³µìˆ˜
function showError(msg) {
    const statusDiv = document.getElementById('statusMessage');
    const submitBtn = document.getElementById('submitBtn');
    statusDiv.className = 'mt-3 alert alert-danger';
    statusDiv.innerText = msg;

    // ì—ëŸ¬ê°€ ë‚˜ë©´ ë‹¤ì‹œ ëˆ„ë¥¼ìˆ˜ìˆìŒ
    submitBtn.disabled = false;
    submitBtn.innerText = "ì—…ë¡œë“œ & ë§ˆìŠ¤í‚¹ ì‹¤í–‰";
}
</script>
{% endblock %}